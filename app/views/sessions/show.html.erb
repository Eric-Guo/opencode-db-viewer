<div class="row justify-content-center">
  <div class="col-lg-12">
    <div class="container">

      <%# === Session Info Card === %>
      <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <svg class="icon me-2">
            <use xlink:href="<%= asset_path('free.svg') %>#cil-chat-bubble"></use>
          </svg>
          <strong><%= t(".session_info") %></strong>
        </div>
        <div class="card-body">
          <div class="row g-3">

            <%# Title %>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".session_title") %></div>
                <div class="fs-5 fw-semibold"><%= @session.title.presence || @session.slug %></div>
              </div>
            </div>

            <%# Version %>
            <div class="col-md-3">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".version") %></div>
                <span class="badge bg-info-gradient text-white"><%= @session.version %></span>
              </div>
            </div>

            <%# Directory %>
            <div class="col-md-3">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".directory") %></div>
                <code class="small"><%= @session.directory %></code>
              </div>
            </div>

            <%# Stats %>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".files_changed") %></div>
                <div class="fs-5 fw-semibold"><%= @session.summary_files || 0 %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".additions") %></div>
                <div class="fs-5 fw-semibold text-success">+<%= @session.summary_additions || 0 %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".deletions") %></div>
                <div class="fs-5 fw-semibold text-danger">-<%= @session.summary_deletions || 0 %></div>
              </div>
            </div>

            <%# Timestamps %>
            <% s_created = @session.time_created_at %>
            <% s_updated = @session.time_updated_at %>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".time_created") %></div>
                <% if s_created %>
                  <div><%= time_tag(s_created, t(".time_ago", distance: time_ago_in_words(s_created)), title: s_created.strftime("%Y-%m-%d %H:%M:%S")) %></div>
                  <div class="small text-medium-emphasis"><%= s_created.strftime("%Y-%m-%d %H:%M:%S") %></div>
                <% else %>
                  <span class="text-medium-emphasis">-</span>
                <% end %>
              </div>
            </div>
            <div class="col-md-6">
              <div class="border rounded p-3 h-100">
                <div class="text-medium-emphasis small text-uppercase fw-semibold mb-1"><%= t(".time_updated") %></div>
                <% if s_updated %>
                  <div><%= time_tag(s_updated, t(".time_ago", distance: time_ago_in_words(s_updated)), title: s_updated.strftime("%Y-%m-%d %H:%M:%S")) %></div>
                  <div class="small text-medium-emphasis"><%= s_updated.strftime("%Y-%m-%d %H:%M:%S") %></div>
                <% else %>
                  <span class="text-medium-emphasis">-</span>
                <% end %>
              </div>
            </div>

          </div>
        </div>
      </div>

      <%# === Message Timeline === %>
      <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
          <svg class="icon me-2">
            <use xlink:href="<%= asset_path('free.svg') %>#cil-history"></use>
          </svg>
          <strong><%= t(".message_timeline") %></strong>
          <span class="badge bg-primary ms-2"><%= @messages.size %> <%= t(".messages") %></span>
        </div>
        <div class="card-body">

          <% if @turns.empty? %>
            <div class="text-center text-medium-emphasis py-4"><%= t(".no_messages") %></div>
          <% else %>
            <% @turns.each_with_index do |turn, turn_idx| %>
              <div class="mb-4">

                <%# === User Message === %>
                <% if turn[:user] %>
                  <% user_msg = turn[:user] %>
                  <div class="d-flex mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="avatar avatar-md bg-primary text-white rounded-circle d-flex align-items-center justify-content-center">
                        <svg class="icon">
                          <use xlink:href="<%= asset_path('free.svg') %>#cil-user"></use>
                        </svg>
                      </div>
                    </div>
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <strong class="me-2"><%= t(".user") %></strong>
                        <% if user_msg.agent.present? %>
                          <span class="badge bg-light text-dark me-2"><%= user_msg.agent %></span>
                        <% end %>
                        <% if user_msg.model_id.present? %>
                          <span class="badge bg-info-gradient text-white me-2"><%= user_msg.model_id %></span>
                        <% end %>
                        <% if user_msg.time_created_at %>
                          <small class="text-medium-emphasis"><%= user_msg.time_created_at.strftime("%H:%M:%S") %></small>
                        <% end %>
                      </div>

                      <% user_parts = user_msg.parts.sort_by { |p| [p.time_created || 0, p.id.to_s] } %>
                      <% user_text_parts = user_parts.select(&:text?).reject { |p| p.text_content.to_s.start_with?("<system-") } %>
                      <% user_text_parts.each do |part| %>
                        <div class="card bg-light border-0 mb-2">
                          <div class="card-body py-2 px-3">
                            <div class="text-break" style="white-space: pre-wrap;"><%= part.text_content %></div>
                          </div>
                        </div>
                      <% end %>

                      <% user_file_parts = user_parts.select(&:file?) %>
                      <% if user_file_parts.any? %>
                        <div class="d-flex flex-wrap gap-2 mt-2">
                          <% user_file_parts.each do |part| %>
                            <span class="badge bg-light text-dark border d-inline-flex align-items-center">
                              <svg class="icon icon-sm me-1">
                                <use xlink:href="<%= asset_path('free.svg') %>#cil-file"></use>
                              </svg>
                              <%= t(".file") %>: <%= part.file_name.presence || "-" %>
                              <% if part.file_url.present? %>
                                <%= link_to t(".open"), part.file_url, class: "ms-2 text-decoration-none", target: "_blank", rel: "noopener noreferrer" %>
                              <% end %>
                            </span>
                          <% end %>
                        </div>
                      <% end %>

                      <% if user_msg.summary_title.present? %>
                        <div class="small text-medium-emphasis fst-italic mt-1">
                          <svg class="icon icon-sm me-1">
                            <use xlink:href="<%= asset_path('free.svg') %>#cil-bookmark"></use>
                          </svg>
                          <%= user_msg.summary_title %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <%# === Assistant Messages === %>
                <% turn[:assistants].each do |asst_msg| %>
                  <div class="d-flex mb-3">
                    <div class="flex-shrink-0 me-3">
                      <div class="avatar avatar-md bg-success text-white rounded-circle d-flex align-items-center justify-content-center">
                        <svg class="icon">
                          <use xlink:href="<%= asset_path('free.svg') %>#cil-bot"></use>
                        </svg>
                      </div>
                    </div>
                    <div class="flex-grow-1 min-width-0">
                      <div class="d-flex align-items-center flex-wrap mb-1">
                        <strong class="me-2"><%= t(".assistant") %></strong>
                        <% if asst_msg.agent.present? %>
                          <span class="badge bg-light text-dark me-1"><%= asst_msg.agent %></span>
                        <% end %>
                        <% if asst_msg.mode.present? %>
                          <span class="badge bg-warning-gradient text-dark me-1"><%= asst_msg.mode %></span>
                        <% end %>
                        <% if asst_msg.model_id.present? %>
                          <span class="badge bg-info-gradient text-white me-1"><%= asst_msg.model_id %></span>
                        <% end %>
                        <% if asst_msg.time_created_at %>
                          <small class="text-medium-emphasis me-2"><%= asst_msg.time_created_at.strftime("%H:%M:%S") %></small>
                        <% end %>
                        <% if asst_msg.finish_reason.present? %>
                          <span class="badge bg-<%= asst_msg.finish_reason == "stop" ? "success" : "secondary" %>"><%= asst_msg.finish_reason %></span>
                        <% end %>
                      </div>

                      <% ordered_parts = asst_msg.parts.sort_by { |p| [p.time_created || 0, p.id.to_s] } %>

                      <%# Reasoning parts (collapsible) %>
                      <% reasoning_parts = ordered_parts.select(&:reasoning?) %>
                      <% if reasoning_parts.any? %>
                        <div class="mb-2">
                          <details>
                            <summary class="text-medium-emphasis small cursor-pointer">
                              <svg class="icon icon-sm me-1">
                                <use xlink:href="<%= asset_path('free.svg') %>#cil-lightbulb"></use>
                              </svg>
                              <%= t(".thinking") %> (<%= reasoning_parts.sum { |p| p.text_content&.length || 0 } %> <%= t(".chars") %>)
                            </summary>
                            <div class="card bg-light border-0 mt-1">
                              <div class="card-body py-2 px-3">
                                <% reasoning_parts.each do |part| %>
                                  <div class="text-break small text-medium-emphasis" style="white-space: pre-wrap;"><%= part.text_content %></div>
                                <% end %>
                              </div>
                            </div>
                          </details>
                        </div>
                      <% end %>

                      <%# Text parts %>
                      <% text_parts = ordered_parts.select(&:text?) %>
                      <% text_parts.each do |part| %>
                        <div class="card border-start border-start-4 border-start-success mb-2">
                          <div class="card-body py-2 px-3">
                            <div class="text-break" style="white-space: pre-wrap;"><%= part.text_content %></div>
                          </div>
                        </div>
                      <% end %>

                      <%# Tool parts %>
                      <% tool_parts = ordered_parts.select(&:tool?) %>
                      <% tool_parts.each do |part| %>
                        <div class="mb-2">
                          <details>
                            <summary class="d-inline-flex align-items-center">
                              <span class="badge bg-dark me-2">
                                <svg class="icon icon-sm me-1">
                                  <use xlink:href="<%= asset_path('free.svg') %>#cil-terminal"></use>
                                </svg>
                                <%= part.tool_name %>
                              </span>
                              <span class="badge bg-<%= part.tool_status == "completed" ? "success" : "warning" %>"><%= part.tool_status %></span>
                            </summary>
                            <div class="card bg-light border-0 mt-1">
                              <div class="card-body py-2 px-3">
                                <% if part.tool_input.present? %>
                                  <div class="mb-2">
                                    <div class="text-medium-emphasis small fw-semibold mb-1"><%= t(".tool_input") %></div>
                                    <pre class="bg-white rounded p-2 small mb-0" style="max-height: 300px; overflow-y: auto;"><code><%= part.tool_input.is_a?(Hash) ? JSON.pretty_generate(part.tool_input) : part.tool_input.to_s %></code></pre>
                                  </div>
                                <% end %>
                                <% if part.tool_output.present? %>
                                  <div>
                                    <div class="text-medium-emphasis small fw-semibold mb-1"><%= t(".tool_output") %></div>
                                    <pre class="bg-white rounded p-2 small mb-0" style="max-height: 300px; overflow-y: auto;"><code><%= part.tool_output.is_a?(Hash) ? JSON.pretty_generate(part.tool_output) : part.tool_output.to_s.truncate(2000) %></code></pre>
                                  </div>
                                <% end %>
                              </div>
                            </div>
                          </details>
                        </div>
                      <% end %>

                      <%# Patch parts %>
                      <% patch_parts = ordered_parts.select(&:patch?) %>
                      <% patch_parts.each do |part| %>
                        <% if part.patch_files.any? %>
                          <div class="mb-2">
                            <details>
                              <summary class="d-inline-flex align-items-center">
                                <span class="badge bg-secondary me-2">
                                  <svg class="icon icon-sm me-1">
                                    <use xlink:href="<%= asset_path('free.svg') %>#cil-code"></use>
                                  </svg>
                                  <%= t(".patch") %>
                                </span>
                                <small class="text-medium-emphasis"><%= part.patch_files.size %> <%= t(".files_affected") %></small>
                              </summary>
                              <div class="card bg-light border-0 mt-1">
                                <div class="card-body py-2 px-3">
                                  <ul class="list-unstyled mb-0">
                                    <% part.patch_files.each do |file| %>
                                      <li class="small"><code><%= file %></code></li>
                                    <% end %>
                                  </ul>
                                </div>
                              </div>
                            </details>
                          </div>
                        <% end %>
                      <% end %>

                      <%# Step finish (token usage) %>
                      <% step_finishes = ordered_parts.select(&:step_finish?) %>
                      <% step_finishes.each do |part| %>
                        <% if part.step_finish_tokens.present? %>
                          <div class="d-flex flex-wrap gap-2 mt-1">
                            <% tokens = part.step_finish_tokens %>
                            <% if tokens["input"].to_i > 0 %>
                              <span class="badge bg-light text-dark border">
                                <svg class="icon icon-sm me-1">
                                  <use xlink:href="<%= asset_path('free.svg') %>#cil-arrow-circle-right"></use>
                                </svg>
                                <%= t(".tokens_in") %>: <%= number_with_delimiter(tokens["input"]) %>
                              </span>
                            <% end %>
                            <% if tokens["output"].to_i > 0 %>
                              <span class="badge bg-light text-dark border">
                                <svg class="icon icon-sm me-1">
                                  <use xlink:href="<%= asset_path('free.svg') %>#cil-arrow-circle-left"></use>
                                </svg>
                                <%= t(".tokens_out") %>: <%= number_with_delimiter(tokens["output"]) %>
                              </span>
                            <% end %>
                            <% if tokens.dig("cache", "read").to_i > 0 %>
                              <span class="badge bg-light text-dark border">
                                <svg class="icon icon-sm me-1">
                                  <use xlink:href="<%= asset_path('free.svg') %>#cil-layers"></use>
                                </svg>
                                <%= t(".cache_read") %>: <%= number_with_delimiter(tokens.dig("cache", "read")) %>
                              </span>
                            <% end %>
                          </div>
                        <% end %>
                      <% end %>

                    </div>
                  </div>
                <% end %>

              </div>

              <%# Turn separator %>
              <% if turn_idx < @turns.size - 1 %>
                <hr class="my-3">
              <% end %>

            <% end %>
          <% end %>

        </div>
      </div>

    </div>
  </div>
</div>
